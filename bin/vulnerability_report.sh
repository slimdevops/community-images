#!/usr/bin/env bash
set -euo pipefail
SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)
HELPER_DIR="$SCRIPT_DIR/helpers"

generate_vscan_report() {
    result_file_path="$PROJECT_FULL_PATH/vscan-xray-reports"
    mkdir -p $result_file_path
    $HELPER_DIR/generate_report.sh "vscan" "$result_file_path/vscan-$2-$3-report.json" "$1" "$2" "$3"
    if [[ "$?" != "0" ]]; then
        exit 1
    fi
}

echo "Vulnerability Scanning Fat Image"
generate_vscan_report $NAMESPACE $REPOSITORY $TAG
echo "Vulnerability Scanning Hardened Image"
generate_vscan_report $SLIM_IMAGE_NS $REPOSITORY $PROJECT_IMAGE_TAG_SLIM
echo "PROJECT_VSCAN_DONE=true" >>$GITHUB_ENV
